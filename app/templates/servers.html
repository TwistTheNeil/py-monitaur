{% extends 'base.html' %}

{% block header %}
  {% block title %}Servers{% endblock %}
{% endblock %}

{% block content %}

<div class="container-fluid">

    <!-- Tool bar -->
    <section class="row">
        <div class="col-md-8">
            <h1>Server list</h1>
        </div>
        <div class="col-md-4">
            <div class="btn-group float-right mt-2" role="group">
                <button type="button" class="btn btn-secondary btn-md" data-toggle="modal" data-target="#registerNewServerModal">New Server</button>
                <button type="button" class="btn btn-secondary btn-md" onclick="refresh_servers();">Refresh</button>
            </div>
        </div>
    </section>

    <!-- Register new server modal -->
    <div class="modal fade" id="registerNewServerModal" tabindex="-1" role="dialog" aria-labelledby="registerNewServerModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="registerNewServerModalLabel">Register new server</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body" id="register-new-server-modal">
                <form id="register-new-server-form" method="POST">
                    <div class="form-group">
                        <label for="registering-server-name">Name</label>
                        <input class="form-control" id="registering-server-name" placeholder="Enter name">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary" onclick="register_new_server();">Save</button>
            </div>
          </div>
        </div>
    </div>

    <div id="servers-section">
    {% for server in server_list %}
        <div class="card server-card">
            <a class="btn card-header text-left" data-toggle="collapse" href="#collapse-{{server['name']}}" role="button" aria-expanded="false">{{server['name']}}</a>
            <div class="card-body collapse" id="collapse-{{server['name']}}">
              <h5 class="card-title">TODO</h5>
              <p class="card-text">More TODO</p>
              <a href="#" class="btn btn-primary" onclick="info_click();">More Info</a>
            </div>
        </div>
    {% endfor %}
    </div>
</div>

<script>

    var data = [
        {
            "name": "cool-name1",
        },
        {
            "name": "lol",
        },
    ];

    function info_click() {
        console.log("safdasfd!!");
    }

    function register_new_server() {
        // Make sure that the input is not empty
        if($.trim($("#registering-server-name").val()) == '') {
            $("#register-new-server-alert-danger").remove();
            $("<div>").addClass("alert alert-danger")
                    .attr("role", "alert")
                    .attr("id", "register-new-server-alert-danger")
                    .text("The name field can't be empty.")
                    .appendTo("#register-new-server-modal");

            return;
        }

        var data = {};
        data['registering-server-name'] = $("#registering-server-name").val();

        $.ajax({
            cache: false,
            url: "{{ url_for('servers.new_server')}}",
            data: data,
            type: "POST",
            dataType: "json",
            success: function(response) {
                $("<div>").addClass("card server-card")
                    .append($("<a>").addClass("btn card-header text-left")
                        .attr("data-toggle", "collapse")
                        .attr("href", "#collapse-"+response.id)
                        .attr("role", "button")
                        .attr("aria-expanded", "false")
                        .text(response.name)
                    )
                    .append($("<div>").addClass("card-body collapse")
                        .attr("id", "collapse-"+response.id)
                        .append($("<h5>").addClass("card-title")
                            .text("TODO-TEXT")
                        )
                        .append($("<p>").addClass("card-text")
                            .text("TODO-p-TEXT")
                        )
                        .append($("<a>").addClass("btn btn-primary")
                            .text("More Info")
                            .attr("onclick", 'info_click()')
                            .attr("href", "#")
                        )
                    )
                    .appendTo("#servers-section");

                $('#registering-server-name').val("");
                $("#register-new-server-alert-danger").remove();
                $('#registerNewServerModal').modal('hide');
            },
            error: function(error) {
                console.log(error)

                $("#register-new-server-alert-danger").remove();
                $("<div>").addClass("alert alert-danger")
                    .attr("role", "alert")
                    .attr("id", "register-new-server-alert-danger")
                    .text("woops") // TODO
                    .appendTo("#register-new-server-modal");
            }
        });
    }

    function refresh_servers() {
        if (data != null) {
            $("#servers-section").empty();

            $.each(data, function(i) {
                $("<div>").addClass("card server-card")
                    .append($("<a>").addClass("btn card-header text-left")
                        .attr("data-toggle", "collapse")
                        .attr("href", "#collapse-"+data[i].name)
                        .attr("role", "button")
                        .attr("aria-expanded", "false")
                        .text(data[i].name)
                    )
                    .append($("<div>").addClass("card-body collapse")
                        .attr("id", "collapse-"+data[i].name)
                        .append($("<h5>").addClass("card-title")
                            .text("TODO-TEXT")
                        )
                        .append($("<p>").addClass("card-text")
                            .text("TODO-p-TEXT")
                        )
                        .append($("<a>").addClass("btn btn-primary")
                            .text("More Info")
                            .attr("onclick", 'info_click()')
                            .attr("href", "#")
                        )
                    )
                    .appendTo("#servers-section");
            });
        }
    }

</script>

{% endblock %}
