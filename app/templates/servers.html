{% extends 'base.html' %}

{% block header %}
  {% block title %}Servers{% endblock %}
{% endblock %}

{% block content %}

<div class="container-fluid">

    <!-- Tool bar -->
    <section class="row">
        <div class="col-md-6 toolbar-row">
            <h2>Server list</h2>
        </div>
        <div class="col-md-6">
            <div class="btn-group float-right mt-2" role="group">
                <button type="button" class="btn btn-secondary btn-md" data-toggle="modal" data-target="#registerNewServerModal">
                    <i class="fa fa-plus fa-sm" aria-hidden="true"></i>
                    Register
                </button>
                <button type="button" class="btn btn-secondary btn-md" onclick="refresh_servers();">
                    <i class="fas fa-sync fa-sm"></i>
                    Refresh
                </button>
            </div>
        </div>
    </section>

    <hr/>

    <!-- Register new server modal -->
    <div class="modal fade" id="registerNewServerModal" tabindex="-1" role="dialog" aria-labelledby="registerNewServerModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="registerNewServerModalLabel">Register new server</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body" id="register-new-server-modal">
                <form id="register-new-server-form" method="POST">
                    <div class="form-group">
                        <label for="registering-server-name">Name</label>
                        <input class="form-control" id="registering-server-name" placeholder="Enter name">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary" onclick="register_new_server();">Save</button>
            </div>
          </div>
        </div>
    </div>

    <!-- Remove server modal -->
    <div class="modal fade" id="removeServerModal" tabindex="-1" role="dialog" aria-labelledby="removeServerModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="removeServerModalLabel">Remove server</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body" id="remove-server-modal">
                <form id="remove-server-form" method="POST">
                    <div class="form-group">
                        <label for="remove-server-name">Are you sure that you would like to remove this server? If you are, please type in the name of the server to verify.</label>
                        <input class="form-control" id="remove-server-name" placeholder="Server name">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-danger" onclick="remove_server();">Remove</button>
            </div>
          </div>
        </div>
    </div>

    <!-- Server list -->
    <div id="servers-section">
    {% for server in server_list %}
        <div class="card server-card">
            <a class="btn card-header text-left" data-toggle="collapse" href="#collapse-{{server['name']}}" role="button" aria-expanded="false">{{server['name']}}</a>
            <div class="card-body collapse" id="collapse-{{server['name']}}">
                <h5 class="card-title">TODO</h5>
                <p class="card-text">More TODO</p>
                <a href="#" class="btn btn-primary" onclick="info_click();">More Info</a>
                <button type="button" id="removeServer-{{server['name']}}" class="btn btn-outline-danger btn-md float-right" data-toggle="modal" data-target="#removeServerModal" onclick="save_server_name(this.id);">
                    <i class="fas fa-trash fa-sm" aria-hidden="true"></i>
                    Remove
                </button>
            </div>
        </div>
    {% endfor %}
    </div>
</div>

<script>

    var data = [
        {
            "name": "cool-name1",
        },
        {
            "name": "lol",
        },
    ];

    var current_server_chosen = "";

    function info_click() {
        console.log("safdasfd!!");
    }

    function save_server_name(server_id) {
        current_server_chosen = server_id.split(/-(.+)/)[1];
    }

    function remove_server() {
        if (current_server_chosen === $("#remove-server-name").val()) {
            //TODO
            return;
        }
        show_alert( "alert alert-danger", "remove-server-alert",
                    "The server name entered doesn't match the one being deleted. Try again.",
                    "#remove-server-form");
    }

    function show_alert(alertClass, alertID, alertText, alertParent) {
        $("#"+alertID).remove();
            $("<div>").addClass(alertClass)
                .attr("role", 'alert')
                .attr("id", alertID)
                .text(alertText)
                .appendTo(alertParent);
    }

    function register_new_server() {
        // Make sure that the input is not empty
        if($.trim($("#registering-server-name").val()) == '') {
            show_alert( "alert alert-danger",
                        "register-new-server-alert-danger",
                        "The name field can't be empty.",
                        "#register-new-server-modal"
            );

            return;
        }

        var data = {};
        data['registering-server-name'] = $("#registering-server-name").val();

        $.ajax({
            cache: false,
            url: "{{ url_for('servers.new_server')}}",
            data: data,
            type: "POST",
            dataType: "json",
            success: function(response) {
                if(response.err != "") {
                    $("#register-new-server-alert-danger").remove();
                    $("<div>").addClass("alert alert-danger")
                        .attr("role", "alert")
                        .attr("id", "register-new-server-alert-danger")
                        .text(response.err)
                        .appendTo("#register-new-server-modal");
                } else {
                    $("<div>").addClass("card server-card")
                        .append($("<a>").addClass("btn card-header text-left")
                            .attr("data-toggle", "collapse")
                            .attr("href", "#collapse-"+response.id)
                            .attr("role", "button")
                            .attr("aria-expanded", "false")
                            .text(response.name)
                        )
                        .append($("<div>").addClass("card-body collapse")
                            .attr("id", "collapse-"+response.id)
                            .append($("<h5>").addClass("card-title")
                                .text("TODO-TEXT")
                            )
                            .append($("<p>").addClass("card-text")
                                .text("TODO-p-TEXT")
                            )
                            .append($("<a>").addClass("btn btn-primary")
                                .text("More Info")
                                .attr("onclick", 'info_click()')
                                .attr("href", "#")
                            )
                        )
                        .appendTo("#servers-section");

                    $('#registering-server-name').val("");
                    $("#register-new-server-alert-danger").remove();
                    $('#registerNewServerModal').modal('hide');
                }
            },
            error: function(error) {
                console.log(error);
                show_alert( "alert alert-danger",
                    "register-new-server-alert-danger",
                    "Server returned error.", //TODO
                    "#register-new-server-modal"
                );
            }
        });
    }

    $(document).ready(function() {
        $("#registerNewServerModal").on("hidden.bs.modal", function(){
            $('#registering-server-name').val("");
            $("#register-new-server-alert-danger").remove();
        });
    });

    function refresh_servers() {
        if (data != null) {
            $("#servers-section").empty();

            $.each(data, function(i) {
                $("<div>").addClass("card server-card")
                    .append($("<a>").addClass("btn card-header text-left")
                        .attr("data-toggle", "collapse")
                        .attr("href", "#collapse-"+data[i].name)
                        .attr("role", "button")
                        .attr("aria-expanded", "false")
                        .text(data[i].name)
                    )
                    .append($("<div>").addClass("card-body collapse")
                        .attr("id", "collapse-"+data[i].name)
                        .append($("<h5>").addClass("card-title")
                            .text("TODO-TEXT")
                        )
                        .append($("<p>").addClass("card-text")
                            .text("TODO-p-TEXT")
                        )
                        .append($("<a>").addClass("btn btn-primary")
                            .text("More Info")
                            .attr("onclick", 'info_click()')
                            .attr("href", "#")
                        )
                    )
                    .appendTo("#servers-section");
            });
        }
    }

</script>

{% endblock %}
